---
title: "data_quality_assessment_malawi"
author: "ojgadabu"
date: "2/5/2019"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r global_options, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 8,
                      warning = FALSE, message = FALSE)


library(gplots)
library(cluster)
library(tidyverse)
library(pwr)
library(xtable)
library(stargazer)
library(knitr)
library(lubridate)
library(RMySQL)
library(stringr)
library(plyr)
#install.packages("table1")
library(table1)
library(data.table)
library(reader)
library(bigmemory)
library(biganalytics)
library(doParallel)
```


## Starting data quality assessment using the kahn framework with the data quality attributes of:

Completeness: Presence of data for an observation regardless of the structure or value of the data. For VL could be -100 or 700 or 200,000.
Conformance: Adherence of data to a predefined format or structure of the data. This could be domain of values, for example, VL not having a value of -20 which would be outside the domain of defined values.
Plausibility: This is the believability or truthfulness of observed data values, for example a patient with two viral load observations of 5000 and 700 within a space of a month. 



```{r manipulation, echo=FALSE, results='hide'}
#knitr::opts_knit$set(root.dir = "~/Box Sync/quantitative_data/")

# read in a dataset with all its tables: 
# test code
#connect to local database to fetch validation tables for plausibility queries

# mydb = dbConnect(MySQL(), user='root', password='', dbname='validation_tables', host='localhost')
 
#Or set this to whereever your R working directory is. The read commands for the datasets will read from your directory too.

patient_address_district_mangochi_df = fread("~/Box Sync/quantitative_data/patient_address/District/mangochi_address.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Mangochi") %>% mutate(unique_patient_id = paste("mh", patient_id, sep="_"))

patient_address_district_nkhatabay_df = fread("~/Box Sync/quantitative_data/patient_address/District/nkhatabay_address.csv")%>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Nkhatabay") %>% mutate(unique_patient_id = paste("nb", patient_id, sep="_"))

patient_address_district_dedza_df = fread("~/Box Sync/quantitative_data/patient_address/District/dedza_address.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Dedza") %>% mutate(unique_patient_id = paste("dz", patient_id, sep="_"))

patient_address_tertiary_kch_df = fread("~/Box Sync/quantitative_data/patient_address/Tertiary/LH_address.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "KCH") %>% mutate(unique_patient_id = paste("kch", patient_id, sep="_"))

patient_address_tertiary_qech_df = fread("~/Box Sync/quantitative_data/patient_address/Tertiary/qech_address.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "QECH") %>% mutate(unique_patient_id = paste("qech", patient_id, sep="_"))

patient_address_tertiary_mch_df = fread("~/Box Sync/quantitative_data/patient_address/Tertiary/mzuzu_central_address.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "MCH") %>% mutate(unique_patient_id = paste("mch", patient_id, sep="_"))

patient_address_tertiary_zch_df = fread("~/Box Sync/quantitative_data/patient_address/Tertiary/zomba_address.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "ZCH") %>% mutate(unique_patient_id = paste("zch", patient_id, sep="_"))

patient_address_healthcenter_kawale_df = fread("~/Box Sync/quantitative_data/patient_address/Health Center/kawale_address.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Kawale")%>% mutate(unique_patient_id = paste("kaw", patient_id, sep="_"))

patient_address_healthcenter_limbe_df = fread("~/Box Sync/quantitative_data/patient_address/Health Center/Limbe_address.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Limbe") %>% mutate(unique_patient_id = paste("lim", patient_id, sep="_"))

patient_address_healthcenter_mapale_df = fread("~/Box Sync/quantitative_data/patient_address/Health Center/mzuzu_mapale_HC_addresses.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Mapale") %>% mutate(unique_patient_id = paste("map", patient_id, sep="_"))


patient_vitals_district_mangochi_df = fread("~/Box Sync/quantitative_data/patient_weight_height/District/mangochi_vitals.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Mangochi") %>% mutate(unique_patient_id = paste("mh", patient_id, sep="_"))

patient_vitals_district_nkhatabay_df = fread("~/Box Sync/quantitative_data/patient_weight_height/District/nkhatabay_vitals.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Nkhatabay") %>% mutate(unique_patient_id = paste("nb", patient_id, sep="_"))

patient_vitals_district_dedza_df = fread("~/Box Sync/quantitative_data/patient_weight_height/District/dedza_vitals.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Dedza") %>% mutate(unique_patient_id = paste("dz", patient_id, sep="_"))


patient_vitals_tertiary_qech_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Tertiary/qech_vitals.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "QECH") %>% mutate(unique_patient_id = paste("qech", patient_id, sep="_"))


patient_vitals_tertiary_kch_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Tertiary/LH_vitals.csv")%>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "KCH") %>% mutate(unique_patient_id = paste("kch", patient_id, sep="_"))

patient_vitals_tertiary_mch_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Tertiary/mzuzu_central.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "MCH") %>% mutate(unique_patient_id = paste("mch", patient_id, sep="_"))

patient_vitals_tertiary_mch_df$encounter_datetime = as.Date(patient_vitals_tertiary_mch_df$encounter_datetime, "%m/%d/%y")  

patient_vitals_tertiary_mch_df$encounter_datetime = as.character(patient_vitals_tertiary_mch_df$encounter_datetime)


patient_vitals_tertiary_zch_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Tertiary/zch_vitals.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "ZCH") %>% mutate(unique_patient_id = paste("zch", patient_id, sep="_"))



patient_vitals_healthcenter_limbe_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Health Center/limbe_vitals.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Limbe") %>% mutate(unique_patient_id = paste("lim", patient_id, sep="_"))

patient_vitals_healthcenter_kawale_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Health Center/kawale_vitals.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Kawale") %>% mutate(unique_patient_id = paste("kaw", patient_id, sep="_"))

patient_vitals_healthcenter_mzuzu_df = fread("~/Box Sync/quantitative_data/patient_weight_height/Health Center/mzuzu_mapale_vitals.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Mapale") %>% mutate(unique_patient_id = paste("map", patient_id, sep="_"))



patient_drugs_district_mangochi_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/District/mangochi_query_drugs2.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Mangochi") %>% mutate(unique_patient_id = paste("mh", patient_id, sep="_"))

patient_drugs_district_dedza_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/District/dedza_query_drugs2.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Dedza") %>% mutate(unique_patient_id = paste("dz", patient_id, sep="_"))

patient_drugs_district_nkhatabay_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/District/nkhatabay_query_drugs2.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Nkhatabay") %>% mutate(unique_patient_id = paste("nb", patient_id, sep="_"))


patient_drugs_tertiary_qech_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Tertiary/qech_query_drugs2.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "QECH") %>% mutate(unique_patient_id = paste("qech", patient_id, sep="_"))

patient_drugs_tertiary_zch_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Tertiary/zomba_qiery2.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "ZCH") %>% mutate(unique_patient_id = paste("zch", patient_id, sep="_"))

patient_drugs_tertiary_kch_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Tertiary/LH_query_drugs2.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "KCH") %>% mutate(unique_patient_id = paste("kch", patient_id, sep="_"))

patient_drugs_tertiary_mch_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Tertiary/mzuzu_central_query_drugs2.csv")%>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "MCH") %>% mutate(unique_patient_id = paste("mch", patient_id, sep="_"))



patient_drugs_healthcenter_limbe_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Health Center/limbe_drugs.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Limbe") %>% mutate(unique_patient_id = paste("lim", patient_id, sep="_"))

patient_drugs_healthcenter_kawale_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Health Center/kawale_drugs.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Kawale") %>% mutate(unique_patient_id = paste("kaw", patient_id, sep="_"))

patient_drugs_healthcenter_mzuzu_df = fread("~/Box Sync/quantitative_data/patient_drugs_taken/Health Center/mapale_drugs.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Mapale") %>% mutate(unique_patient_id = paste("map", patient_id, sep="_"))


patient_drug_adherence_district_nkhatabay_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/District/nkhatabay_adherence.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Nkhatabay") %>% mutate(unique_patient_id = paste("nb", person_id, sep="_"))

patient_drug_adherence_district_mangochi_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/District/mangochi_adherence.csv") %>% mutate(health_facility_name = "Mangochi") %>% mutate(unique_patient_id = paste("mh", person_id, sep="_"))

patient_drug_adherence_district_dedza_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/District/dedza_adherence.csv") %>% mutate(health_facility_name = "Dedza") %>% mutate(unique_patient_id = paste("dz", person_id, sep="_"))

patient_drug_adherence_tertiary_qech_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Tertiary/qech_adherence.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "QECH") %>% mutate(unique_patient_id = paste("qech", person_id, sep="_"))

patient_drug_adherence_tertiary_zch_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Tertiary/zch_adherence.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "ZCH") %>% mutate(unique_patient_id = paste("zch", person_id, sep="_"))

patient_drug_adherence_tertiary_kch_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Tertiary/LH_adherence.csv") %>% mutate(health_facility_name = "KCH") %>% mutate(unique_patient_id = paste("kch", person_id, sep="_"))

patient_drug_adherence_tertiary_mch_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Tertiary/mzuzu_central_adherence.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "MCH") %>% mutate(unique_patient_id = paste("mch", person_id, sep = "_"))

patient_drug_adherence_healthcenter_kawale_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Health Center/kawale_adherence.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Kawale") %>% mutate(unique_patient_id = paste("kaw", person_id, sep ="_"))

patient_drug_adherence_healthcenter_limbe =  fread("~/Box Sync/quantitative_data/patient_drug_adherence/Health Center/limbe_adherence.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Limbe") %>% mutate(unique_patient_id = paste("lim", person_id, sep ="_"))

patient_drug_adherence_healthcenter_mzuzu_df = fread("~/Box Sync/quantitative_data/patient_drug_adherence/Health Center/mapale_adherence.csv")%>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Mapale") %>% mutate(unique_patient_id = paste("map", person_id, sep="_"))



patient_vl_district_mangochi_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/District/mangochi_VL.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Mangochi") %>% mutate(unique_patient_id = paste("mh", patient_id, sep="_"))

patient_vl_district_dedza_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/District/dedza_VL.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Dedza") %>% mutate(unique_patient_id = paste("dz", patient_id, sep="_"))

patient_vl_district_nkhatabay_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/District/nkhatabay_VL.csv") %>% mutate(health_facility_type = "District") %>% mutate(health_facility_name = "Nkhatabay") %>% mutate(unique_patient_id = paste("nb", patient_id, sep="_"))
patient_vl_tertiary_qech_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/Tertiary/qech_VL.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "QECH") %>% mutate(unique_patient_id = paste("qech", patient_id, sep="_"))
#patient_vl_files_tertiary_zch = list.files(path="~/Box Sync/quantitative_data/hiv_viral_load/Tertiary/", pattern="*.csv", full.names=TRUE)
patient_vl_tertiary_kch_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/Tertiary/LH_VL.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "KCH") %>% mutate(unique_patient_id = paste("kch", patient_id, sep="_"))
patient_vl_tertiary_mch_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/Tertiary/mzuzu_central_VL.csv") %>% mutate(health_facility_type = "Tertiary") %>% mutate(health_facility_name = "Mzuzu") %>% mutate(unique_patient_id = paste("map", patient_id, sep="_"))
patient_vl_files_health_center_limbe = fread("~/Box Sync/quantitative_data/hiv_viral_load/Health Center/limbe_VL.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Limbe") %>% mutate(unique_patient_id = paste("lim", patient_id, sep="_"))
patient_vl_health_center_kawale_df = fread("~/Box Sync/quantitative_data/hiv_viral_load/Health Center/kawale_VL.csv") %>% mutate(health_facility_type = "Health Center") %>% mutate(health_facility_name = "Kawale") %>% mutate(unique_patient_id = paste("kaw", patient_id, sep="_"))
#consistent names for Rbind
names(patient_vl_tertiary_kch_df)[names(patient_vl_tertiary_kch_df) == "patient_ART_start_date"] = "ART_start_date"

names(patient_vl_tertiary_mch_df)[names(patient_vl_tertiary_mch_df) == "patient_ART_start_date"] = "ART_start_date" 
names(patient_vl_tertiary_qech_df)[names(patient_vl_tertiary_qech_df) == "patient_ART_start_date"] = "ART_start_date"   


#patient_vl_files_health_center_mzuzu = list.files(path="~/Box Sync/quantitative_data/hiv_viral_load/Health Center/", pattern="*.csv", full.names=TRUE)

#combine data frames
patient_address_list = list(patient_address_healthcenter_kawale_df,patient_address_healthcenter_limbe_df,patient_address_healthcenter_mapale_df,patient_address_district_mangochi_df,patient_address_district_dedza_df,patient_address_district_nkhatabay_df,patient_address_tertiary_kch_df,patient_address_tertiary_mch_df,patient_address_tertiary_qech_df,patient_address_tertiary_zch_df)

patient_vitals_list = list(patient_vitals_healthcenter_mzuzu_df,patient_vitals_healthcenter_kawale_df,patient_vitals_healthcenter_limbe_df,patient_vitals_tertiary_mch_df,patient_vitals_tertiary_qech_df,patient_vitals_tertiary_zch_df,patient_vitals_tertiary_kch_df,patient_vitals_district_dedza_df,patient_vitals_district_mangochi_df,patient_vitals_district_nkhatabay_df)

patient_adherence_list = list(patient_drug_adherence_district_nkhatabay_df,patient_drug_adherence_healthcenter_kawale_df,patient_drug_adherence_healthcenter_mzuzu_df,patient_drug_adherence_tertiary_qech_df,patient_drug_adherence_tertiary_mch_df,patient_drug_adherence_tertiary_zch_df) # healthcenter data frames are off

patient_drugs_list = list(patient_drugs_healthcenter_kawale_df,patient_drugs_healthcenter_limbe_df,patient_drugs_healthcenter_mzuzu_df,patient_drugs_district_dedza_df,patient_drugs_district_nkhatabay_df,patient_drugs_district_mangochi_df,patient_drugs_tertiary_kch_df,patient_drugs_tertiary_mch_df,patient_drugs_tertiary_qech_df,patient_drugs_tertiary_zch_df)  # all data frames are off.

patient_vl_list = list(patient_vl_health_center_kawale_df,patient_vl_files_health_center_limbe ,patient_vl_tertiary_mch_df,patient_vl_tertiary_kch_df,patient_vl_tertiary_qech_df,patient_vl_district_nkhatabay_df,patient_vl_district_dedza_df,patient_vl_district_mangochi_df)


all_health_facility_addresses = rbindlist(patient_address_list, use.names=TRUE)
all_health_facility_vitals = rbindlist(patient_vitals_list, use.names = TRUE)
all_health_facility_adherence = rbindlist(patient_adherence_list,use.names = TRUE, fill = TRUE)
all_health_facility_drugs = rbindlist(patient_drugs_list, use.names = TRUE, fill = TRUE)
all_health_facility_vl = rbindlist(patient_vl_list, use.names = TRUE,fill=TRUE)

#Denominators
#Total number of patients alive during the study period. Select all patients that are alive during the study period

all_study_patients = all_health_facility_addresses %>% unique.data.frame()
total_number_of_all_patients = nrow(all_study_patients)

#Patient visits. Currently using patient visits because that is the highest encounter type.This will be replaced by HIV reception encounter since some visits are guardian visits where the patient is not present and hence will not have a weight encounter.
all_health_facility_vitals$encounter_datetime = as.Date(all_health_facility_vitals$encounter_datetime) 

study_patient_visits = all_health_facility_vitals %>% filter((encounter_datetime) > "2017-01-01") %>%  group_by(unique_patient_id,encounter_datetime)  

total_number_of_patient_visits = nrow(study_patient_visits)

 #completeness
 #Patient retention and health tracking
 #Denominator is all patient visits during the study period (January 2017 to December 2018). At minimum, each patient should have their vital signs measured when they visit the clinic. Therefore the denominator will be the number of encounters in the weight table for now pending the change above. 

#Fix gender variable for address table.
all_health_facility_addresses$gender = ifelse (all_health_facility_addresses$gender == "F" | all_health_facility_addresses$gender == "Female","Female","Male")

#Physical Address All Health Facilities
all_health_facility_addresses$complete_address =  ifelse(all_health_facility_addresses$district !="NULL" & all_health_facility_addresses$ta != "NULL" &     all_health_facility_addresses$village != "NULL", "Complete","Incomplete")
number_of_all_complete_addresses = all_health_facility_addresses %>% filter(complete_address =="Complete") %>% nrow()
all_address_completeness_proportion = number_of_all_complete_addresses / total_number_of_all_patients * 100

#Phone number
all_health_facility_addresses$phone_number =  ifelse(all_health_facility_addresses$cell_number !="NULL" & (all_health_facility_addresses$cell_number != "Unknown" |   all_health_facility_addresses$cell_number != "N/A"), "Complete","Incomplete")

number_of_all_complete_phone_numbers = all_health_facility_addresses %>% filter(phone_number =="Complete") %>% nrow()
all_phone_number_proportion = number_of_all_complete_phone_numbers/total_number_of_all_patients*100

#Weight observation for BMI calculation

all_health_facility_vitals$complete_weight = ifelse(all_health_facility_vitals$weight != "NULL", "Complete","Incomplete") 

complete_weight_encounter_observations = all_health_facility_vitals %>% filter(encounter_datetime >= "2017-01-01") %>%  filter(complete_weight == "Complete")

all_number_of_complete_weight_observations = nrow(complete_weight_encounter_observations)

all_weight_encounters = complete_weight_encounter_observations %>% filter(complete_weight == "Complete") %>% group_by(unique_patient_id,encounter_datetime) %>% slice(1) 

total_number_of_weight_visits = nrow(all_weight_encounters)

proportion_weight_encounters = total_number_of_weight_visits / total_number_of_patient_visits *100
  
proportion_all_complete_weight_documentation = all_number_of_complete_weight_observations / total_number_of_patient_visits  * 100

# library(devtools)
# install_github("emwozniak/Table1")
# library(Table1)
# 
# make.table(dat          = all_weight_encounters,
#            strat        = "complete_weight",
#            cat.varlist  = c("health_facility_type", "complete_weight"),
#            cat.rmstat   = list(c("row"), c("col")),
#            cat.ptype    = c("chisq"),
#            output       = "html")


  
#Height observation for BMI calculation. The assumption is that every patient should have one height observation.

all_height_encounters = all_health_facility_vitals %>% filter(encounter_datetime >= "2017-01-01") %>% filter(height != "NULL") %>% group_by(encounter_datetime,unique_patient_id) %>% slice(1)

all_number_height_encounters_observations = all_health_facility_vitals %>% filter(encounter_datetime >= "2017-01-01") %>% filter(height != "NULL") %>% nrow()

total_number_of_height_visits = nrow(all_height_encounters)

proportion_height_encounters = total_number_of_height_visits / total_number_of_patient_visits *100

#proportion_of_all_height_observations = all_number_of_height_observations / total_number_of_all_patients * 100

#Prescription. Probably need the encounter id
#Denominator will be total number of prescriptions made. A patient may have multiple prescriptions made on any single visit. In this case, the denominator differs with the weight denominator where the expectation is a single value for each day.
#Considering that the denominator is the number of patient visits at a health facility. I will first of all take all the patient visits that have a drug prescription.
all_health_facility_drugs$start_date_new = as.Date(all_health_facility_drugs$start_date,"%m/%d/%y")

prescription_encounter_observations = all_health_facility_drugs %>% filter(date(start_date_new) >= "2017-01-01") %>%  inner_join(.,study_patient_visits, by = "unique_patient_id")   

prescription_encounters = prescription_encounter_observations %>%  group_by(unique_patient_id,health_facility_name.x) %>%  slice(1)

#prescription_encounters_b = all_health_facility_drugs %>% filter(date(start_date_new) >= "2017-01-01") %>% group_by(unique_patient_id) %>% slice(1)

update_names = function(drug_table){
   i = 1
   output_drugs = character(nrow(drug_table))
   output_quantity = character(nrow(drug_table))
   output_category = character(nrow(drug_table))
   while(i < nrow(drug_table)){
   test_evening = grepl("Evening",drug_table[i,]$name)
   if((test_evening == TRUE)){
       output_drugs[i] = drug_table[i,]$quantity 
       output_quantity[i] = drug_table[i,]$regimen_category
       output_category[i] = drug_table[i,]$V8
  print("evening")
  }else{
       output_drugs[i] = drug_table[i,]$name
       output_quantity[i] = drug_table[i,]$quantity
       output_category[i] = drug_table[i,]$regimen_category
   print("madzulo")    
  }
  i = i+1
}
   drug_table$name = output_drugs
   drug_table$quantity = output_quantity
   drug_table$regimen_category = output_category
   return(as.data.frame(drug_table))
}

#prescription_encounter_observations = update_names(prescription_encounter_observations)

if(find.file("cleaned_prescription_encounters.csv") == "cleaned_prescription_encounters.csv"){
  prescription_encounters = fread("cleaned_prescription_encounters.csv")
}else{
 prescription_encounters = (update_names(prescription_encounters))
 write.csv((prescription_encounters), file = "cleaned_prescription_encounters.csv")
}


#Calculate proportions of drug encounters among patient visits

number_of_prescription_encounters = (nrow(prescription_encounters))

proportion_drug_encounters =  number_of_prescription_encounters / total_number_of_patient_visits * 100

total_number_of_all_prescriptions = 1 #all_health_facility_drugs %>% nrow()
#Analyze the denominator by month. Is it exhibiting similar average counts. Is there evidence to suggest that some records were not entered in some months for example over the study period. Plot of count of visits over two years.
 

number_of_all_complete_prescriptions = 1 #all_health_facility_drugs %>% filter(quantity != "NULL") %>% nrow() # NULL
#records indicate that the prescription was not filled. We take only complete prescriptions here.

all_prescription_completeness_proportion = number_of_all_complete_prescriptions / total_number_of_all_prescriptions * 100

 
#Adherence
#This will be all patient visits that have an adherence encounter, since the patient visit is the denominator.

#Remove % from adherence 

all_health_facility_adherence$adherence_in_percentage = str_replace(all_health_facility_adherence$adherence_in_percentage, "%","")

all_health_facility_adherence$start_date_new = as.Date(all_health_facility_adherence$start_date, "%Y-%m-%d")

adherence_encounter_observations = all_health_facility_adherence %>% filter(start_date_new >= "2017-01-01") %>% group_by(unique_patient_id) 

adherence_encounters = inner_join(adherence_encounter_observations,study_patient_visits, by = "unique_patient_id") %>% group_by(unique_patient_id,encounter_datetime) %>% slice(1)

number_of_adherence_visits =  nrow(adherence_encounters)

proportion_adherence_encounters = number_of_adherence_visits / total_number_of_patient_visits * 100

# Adherence observations completeness check
all_health_facility_adherence = mutate(all_health_facility_adherence, complete_adherence = ifelse(adherence_in_percentage == "NULL", "Incomplete","Complete"))

number_of_all_patients_with_complete_adherence = all_health_facility_adherence  %>% filter(complete_adherence == "Complete") %>% nrow()
number_of_all_patient_adherence_visits = all_health_facility_adherence %>% filter(start_date_new >= "2017-01-01" & !is.na(adherence_in_percentage)) %>%  nrow()

all_proportion_adherence = number_of_all_patients_with_complete_adherence / number_of_all_patient_adherence_visits * 100


 
 #Viral load
 #total number of patients that have been registered since the begining of the clinic to 6 months before the end of the study period
 #number of patients with a viral load reading documented in this period.
 #The tables here from one clinic only. The others are being uploaded.
#The denominator here will be total number of patients in the study. The assumption is that all the study patients should have at least one viral load encounter by the time of the study. We shall consider patients that had a viral load even before the study period since this is the only documented viral load observation.

patient_vl_encounters = inner_join(all_study_patients, all_health_facility_vl, by = "unique_patient_id") %>% group_by(unique_patient_id,patient_visit_date) %>% slice(1)

number_of_vl_visits = nrow(patient_vl_encounters)

proportion_of_vl_encounters = number_of_vl_visits / total_number_of_all_patients * 100

total_number_vl_all_patients = all_health_facility_vl %>% nrow()
# Viral load observations completeness
all_health_facility_vl$complete_viral_load =  ifelse((all_health_facility_vl$patient_VL_results != "" & all_health_facility_vl$patient_VL_results != "NULL"), "Complete","Incomplete") 
number_of_all_complete_viral_loads = all_health_facility_vl %>% filter(complete_viral_load == "Complete")  %>% nrow()
proportion_of_all_complete_vl = number_of_all_complete_viral_loads/total_number_vl_all_patients * 100
 
#Read table of importance characteristics to count priority of importance based on 90-90-90

importance_priorities = fread("~/Dropbox/dissertation_data_analysis/importance_characteristics.csv")

#Build the completeness data tables

######### 
# Completeness Table for All Health Facilities for Encounter Observations

variable_names_all = c("Current Patient Address","Patient Mobile Phone Number","Weights of Patient","HIV Viral Load","Prescriptions Made","Drug Adherence")

numerators_all = c(number_of_all_complete_addresses,number_of_all_complete_phone_numbers,all_number_of_complete_weight_observations,number_of_all_complete_viral_loads,number_of_all_complete_prescriptions,number_of_all_patients_with_complete_adherence)

denominators_all = c(total_number_of_all_patients,total_number_of_all_patients,total_number_of_patient_visits,total_number_vl_all_patients,total_number_of_all_prescriptions,number_of_all_patient_adherence_visits)

proportions_all = c(all_address_completeness_proportion,all_phone_number_proportion,proportion_all_complete_weight_documentation,proportion_of_all_complete_vl,all_prescription_completeness_proportion,all_proportion_adherence)
 
all_healthfacility_completeness_table = data.frame(variable_names_all,numerators_all,denominators_all,proportions_all, stringsAsFactors = FALSE)
 
all_healthfacility_completeness_table_b = data.frame(variable_names_all,numerators_all,denominators_all,proportions_all, stringsAsFactors = FALSE)

all_healthfacility_completeness_table$numerators_all = as.numeric(all_healthfacility_completeness_table$numerators_all)

all_healthfacility_completeness_table$denominators_all = as.numeric(all_healthfacility_completeness_table$denominators_all)

all_healthfacility_completeness_table$proportions_all = as.numeric(all_healthfacility_completeness_table$proportions_all)


#Create Completeness Table for Patient Visits and Encounters

variable_names_encounters = c("Current Patient Address","Patient Mobile Phone Number","Weights of Patient","Heights of Patient","Prescriptions Made","Drug Adherence", "HIV Viral Load")


encounter_numerators  = c(number_of_all_complete_addresses,number_of_all_complete_phone_numbers,total_number_of_weight_visits,total_number_of_height_visits,number_of_prescription_encounters,number_of_adherence_visits,number_of_vl_visits)

encounter_denominators = c(total_number_of_all_patients,total_number_of_all_patients,total_number_of_patient_visits,total_number_of_patient_visits,total_number_of_patient_visits,total_number_of_patient_visits,total_number_of_all_patients)

proportion_encounters = c(all_address_completeness_proportion,all_phone_number_proportion,proportion_weight_encounters,proportion_height_encounters, proportion_drug_encounters, proportion_adherence_encounters, proportion_of_vl_encounters) 


all_encounters_completeness_table = data.frame(variable_names_encounters,encounter_numerators,encounter_denominators,proportion_encounters, stringsAsFactors = FALSE)
 
#
all_encounters_completeness_table_b = data.frame(variable_names_encounters,encounter_numerators,encounter_denominators, stringsAsFactors = FALSE)
 
#
all_encounters_completeness_table$encounter_numerators = as.numeric(all_encounters_completeness_table$encounter_numerators)

all_encounters_completeness_table$encounter_denominators = as.numeric(all_encounters_completeness_table$encounter_denominators)

####
all_encounters_completeness_table_b$encounter_numerators = as.numeric(all_encounters_completeness_table_b$encounter_numerators)
all_encounters_completeness_table_b$encounter_denominators = as.numeric(all_encounters_completeness_table_b$encounter_denominators)
#####


all_encounters_completeness_table$proportion_encounters = as.numeric(all_encounters_completeness_table$proportion_encounters)



### factor these variables for table 1
all_health_facility_addresses$health_facility_type = factor(all_health_facility_addresses$health_facility_type)
all_health_facility_addresses$health_facility_name = factor(all_health_facility_addresses$health_facility_name)
all_health_facility_addresses$gender = factor(all_health_facility_addresses$gender)
all_health_facility_addresses$complete_address = factor(all_health_facility_addresses$complete_address)

all_health_facility_vitals$health_facility_type = factor(all_health_facility_vitals$health_facility_type)
all_health_facility_vitals$health_facility_name = factor(all_health_facility_vitals$health_facility_name)

all_health_facility_vl$health_facility_type = factor(all_health_facility_vl$health_facility_type)
all_health_facility_vl$health_facility_name = factor(all_health_facility_vl$health_facility_name)

all_health_facility_adherence$health_facility_type = factor(all_health_facility_adherence$health_facility_type)

all_health_facility_adherence$health_facility_name = factor(all_health_facility_adherence$health_facility_name)

all_health_facility_drugs$health_facility_type = factor(all_health_facility_drugs$health_facility_type)
all_health_facility_drugs$health_facility_name = factor(all_health_facility_drugs$health_facility_name)

all_health_facility_drugs$regimen_category_new = factor(all_health_facility_drugs$regimen_category)

###

# cd$address_value = ifelse(cd$address_value == "Other"), "Other", cd$address_value))

 #What is the completeness of individual sections of patient address since it is divided into 3 parts.This is checking the denominators. 
 
cd = gather(all_health_facility_addresses,"address_section","address_value",2:4) 
 
cd$address_value = ifelse((cd$address_value == "Other"), "Documented Other",cd$address_value)
cd$address_value = ifelse((cd$address_value == "NULL"), "Not documented",cd$address_value)
cd$address_value = ifelse((cd$address_value != "Documented Other" &  cd$address_value != "Not documented" ), "Address Unit Documented",      cd$address_value) 

cd$address_section = as.factor(cd$address_section)
cd$address_value = as.factor(cd$address_value)
 


#Table 1 study patients characteristics

#Filter by healthfacility type and then tabulate data based on health facility type (health center, district and tertiary)

health_center_addresses = all_health_facility_addresses %>% filter(health_facility_type == "Health Center")
district_addresses = all_health_facility_addresses %>% filter(health_facility_type == "District")
tertiary_addresses = all_health_facility_addresses %>% filter(health_facility_type == "Tertiary")

agebreaks <- c(0,1,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,500)
agelabels <- c("0-1","1-4","5-9","10-14","15-19","20-24","25-29","30-34",
               "35-39","40-44","45-49","50-54","55-59","60-64","65-69",
               "70-74","75-79","80-84","85+")

setDT(all_health_facility_addresses)[ , agegroups := cut(age, 
                                breaks = agebreaks, 
                                right = FALSE, 
                                labels = agelabels)]



all_study_patients_characteristics = table1(~gender + agegroups + age|health_facility_type, data = all_health_facility_addresses, output = "pandoc")


study_patients_at_health_centers = table1(~gender + age|health_facility_name, data = health_center_addresses, output = "html")

study_patients_at_district_hospitals = table1(~gender + age|health_facility_name, data = district_addresses, output = "html")

study_patients_at_tertiary = table1(~gender + age|health_facility_name, data = tertiary_addresses, output = "html")

#Breakdown patient visits by health facility type and name as denominator for each health facility

number_of_patient_visits_per_health_facility = table1(~health_facility_name, data = study_patient_visits)


 #Analyze the addresses as the field used for following up patients. Check the total number of patients that have been registered at each facility. Modification is that patient identifier no longer checked because HIV Testing Services (HTS) is not part of the available EMRs. Therefore check for total number of patients per site, then assess completeness of physical address as a set of "TA, district and village (current place of residence)"
#Patients with complete physical addresses. We define complete village as all addresses that have got the smallest unit of address which represents the current place of residence. Residents without current place of residence cannot be followed up if they miss an appointment. This is a threat to the second 90 of patient retention. 

 
```


  
```{r, plausibility, echo=FALSE, results='hide',include=FALSE}  
  
  
#Plausibility. Are the data that have been built believable? Are they accurate. We assess the complete data here.

#Patientaddress Plausibility.
#Denominator will be the number of complete patient addresses.
#Numerator, will be the number of addresses that fall within accepted addresses.


mydb = dbConnect(
  MySQL(),
  user = 'root',
  password = '',
  dbname = 'validation_tables',
  host = 'localhost'
)
rs1 = dbSendQuery(
  mydb,
  "select village.name as village_name, traditional_authority.name as ta_name, district.name as district_name from village inner join traditional_authority using(traditional_authority_id) inner join district on traditional_authority.district_id = district.district_id"
)
joined_addresses = dbFetch(rs1, n = -1)

dbClearResult(rs1)
dbDisconnect(mydb)

all_health_facility_addresses = mutate(all_health_facility_addresses, plausible_address = "Not Plausible")

plausible_physical_address <- function(address_table) {

#Initialize vectors
plausible_address_vector = character(nrow(address_table))
districts_vector = character(nrow(address_table))
ta_vector = character(nrow(address_table))
village_vector = character(nrow(address_table))


districts_vector = address_table$district
ta_vector = address_table$ta
village_vector = address_table$village  

i = 1
while (i <= nrow(address_table))
{
  jd = joined_addresses %>% filter(
    district_name == districts_vector[i] &
      ta_name == ta_vector[i] &
      village_name == village_vector[i]
  )
  plausible_address_vector[i]= ifelse(empty(jd) == TRUE, "Not Plausible", "Plausible")
  i = i + 1

  if(i%%1000 == 10){print(paste("Xerxes",i, sep ="_"))}
}
return(plausible_address_vector)
}



if (find.file("all_health_facility_addresses.csv") == "all_health_facility_addresses.csv")
{
  all_health_facility_addresses = fread("all_health_facility_addresses.csv")  
}else{ 
  all_health_facility_addresses$plausible_address =  plausible_physical_address(all_health_facility_addresses) 
  write.csv(all_health_facility_addresses, file = "all_health_facility_addresses.csv")
}

number_of_all_plausible_addresses = all_health_facility_addresses %>%  filter(plausible_address == "Plausible") %>% nrow()

proportion_of_all_plausible_addresses = number_of_all_plausible_addresses / number_of_all_complete_addresses * 100

#

#regular expression pattern for phone numbers. Filter those that are non numeric and are more than or less than 10 digits.

all_health_facility_addresses$plausible_phone_number = ifelse(str_length(all_health_facility_addresses$cell_number) == 10,"Plausible","Not Plausible")


number_of_all_plausible_phone_numbers = all_health_facility_addresses %>% filter(plausible_phone_number == "Plausible") %>% nrow()


proportion_of_all_plausible_numbers = number_of_all_plausible_phone_numbers / number_of_all_complete_phone_numbers * 100


# Plausible Weight Values. This will take into consideration all weight observations that were made during the study visit. Then check the weight values that fall within accepted thresholds.

# Examine the data for outliers 
all_health_facility_vitals$height_new = as.numeric(all_health_facility_vitals$height)
all_health_facility_vitals$weight_new = as.numeric(all_health_facility_vitals$weight)


#at observation level
study_period_vitals = all_health_facility_vitals %>% filter(encounter_datetime >= "2017-01-01")



# add age and sex for study period vitals


#vectorize weight and height

pat_weight_vector = study_period_vitals$weight
pat_height_vector = study_period_vitals$height


if(find.file("study_period_vitals.csv") == "study_period_vitals.csv")
{

  study_period_vitals = fread("study_period_vitals.csv")  

}else{

study_period_vitals_age = character(nrow(study_period_vitals))
study_period_vitals_sex = character(nrow(study_period_vitals))
vitals_id = character(nrow(study_period_vitals))
vitals_id  = study_period_vitals$unique_patient_id

for(i in 1:nrow(study_period_vitals)){
  patient = all_study_patients %>% filter(unique_patient_id == vitals_id[i]) 
  if(empty(patient) == FALSE){
   study_period_vitals_age[i] = patient$age
   study_period_vitals_sex[i] = patient$gender
  }
}

study_period_vitals$age = study_period_vitals_age
study_period_vitals$sex = study_period_vitals_sex
study_period_vitals$age = as.numeric(study_period_vitals$age)

study_period_vitals = mutate(study_period_vitals, study_age_in_months = study_period_vitals$age*12)  
write.csv(study_period_vitals, file = "study_period_vitals.csv")
}


weight_height_lookup_table = fread("~/Dropbox/dissertation_data_analysis/wtht_rangecheck.csv", col.names = c("age_in_months", "sex","low_height", "high_height", "low_weight", "high_weight"))

study_period_vitals = study_period_vitals %>% filter(sex != "")
plausible_vitals_weight = character(nrow(study_period_vitals))
plausible_vitals_height = character(nrow(study_period_vitals))

study_period_vitals$sex = ifelse(study_period_vitals$sex == "F" | study_period_vitals$sex == "Female", "Female","Male")

if(find.file("study_period_vitals_plausible.csv") == "study_period_vitals_plausible.csv"){
  study_period_vitals = fread("study_period_vitals_plausible.csv")
  
}else{

  for(i in 1:nrow(study_period_vitals)){
  
  study_sex = ifelse(study_period_vitals[i,]$sex == "Male",0,1)
  study_age_in_months = study_period_vitals[i,]$study_age_in_months
  if(study_age_in_months <= 215){
    validating_record = weight_height_lookup_table %>% filter(age_in_months == study_age_in_months & sex == study_sex)
    
    plausible_vitals_weight[i] = ifelse(as.numeric(pat_weight_vector[i]) >= validating_record$low_weight & as.numeric(pat_weight_vector[i]) <= validating_record$high_weight,"Plausible","Not Plausible" )
    print("sindindalowe!")
    print(pat_height_vector[i])
    print(i)
    if((pat_height_vector[i]) != "NULL"){
      print("ndalowa!")
      print(pat_height_vector[i])
      plausible_vitals_height[i] = ifelse(as.numeric(pat_height_vector[i]) >= validating_record$low_height & as.numeric(pat_height_vector[i]) <= validating_record$high_height,"Plausible","Not Plausible" )
    }
    
  }else
  {# check absolute weight and height for older patients
    #check absolute height first
    plausible_vitals_height[i] = ifelse(as.numeric(pat_height_vector[i]) >= 10 & as.numeric(pat_height_vector[i])<= 200,"Plausible","Not Plausible")
    plausible_vitals_weight[i] = ifelse(as.numeric(pat_weight_vector[i]) >= 0 & as.numeric(pat_weight_vector[i])<= 250,"Plausible","Not Plausible")
  }
}
study_period_vitals$plausible_weight  = plausible_vitals_weight
study_period_vitals$plausible_height = plausible_vitals_height
write.csv(study_period_vitals, file = "study_period_vitals_plausible.csv")
}

number_of_plausible_weight_observations = study_period_vitals %>% filter(plausible_weight == "Plausible") %>%  nrow()

proportion_all_plausible_weights = number_of_plausible_weight_observations/total_number_of_weight_visits * 100

# Plausible Height Values

number_of_all_plausible_height_observations = study_period_vitals %>% filter(plausible_height == "Plausible") %>%  nrow()

proportion_all_plausible_heights = number_of_all_plausible_height_observations/all_number_height_encounters_observations * 100


#Plausible Drugs
#Check if the prescribed drug == the dispensed drug
#Check if the dispensed quantity is above expected threshholds
#Prescription observations
all_health_facility_drugs$quantity = as.numeric(all_health_facility_drugs$quantity)
all_health_facility_drugs$regimen_category = as.factor(all_health_facility_drugs$regimen_category)
# how to handle now ARVs? Compile a list of ARVs. Filter only those

list_of_arv_drugs = c("Etravirine 100mg","d4T (Stavudine 40mg tablet","LPV/r (Lopinavir and Ritonavir syrup)" ,"d4T (Stavudine 30mg tablet)","Ritonavir 100mg","Dolutegravir (50mg tablet)","TDF300/3TC300 + LPV/r200/50","NVP (Nevirapine syrup 1mL/dose in 100mL bottle)","ABC (Abacavir 300mg tablet)","NVP (Nevirapine 50 mg tablet)","ATV/(Atazanavir)","LPV/r (Lopinavir and Ritonavir 100/25mg tablet)" , "AZT/3TC/TDF/LPV/r","AZT (Zidovudine 300mg tablet)","ABC/3TC (Abacavir and Lamivudine 60/30mg tablet)","LS30 (Stavudine and Lamivudine 30mg tablet)","LPV/r (Lopinavir and Ritonavir 200/50mg tablet)","d4T/3TC/EFV (Stavudine Lamvudine Efavirenz)","TDF (Tenofavir 300 mg tablet)","TDF300/3TC300/DTG50","EFV (Efavirenz 200mg tablet)","Coviro40 (Lamivudine + Stavudine 150/40mg tablet)","AZT/3TC (Zidovudine and Lamivudine 60/30 tablet)","Clotrimazole pessaries","TMP/SMX (Cotrimoxazole 240mg tablet)","TMP/SMX (Cotrimoxazole 800/160mg tablet)","TMP/SMX (Cotrimoxazole 200/40mg tablet)","AZT/3TC/NVP","Coviro30 (Lamivudine + Stavudine 150/30 mg tablet)","ABC/3TC (Abacavir and Lamivudine 600/300mg tablet)","AZT/3TC (Zidovudine and Lamivudine 300/150mg)","ATV/r (Atazanavir 300mg/Ritonavir 100mg)","EFV (Efavirenz 600mg tablet)","AZT/3TC/NVP (60/30/50mg tablet)","Cotrimoxazole (1920mg)","d4T/3TC (Stavudine Lamivudine 6/30mg tablet)","TMP/SMX (Cotrimoxazole 400/80mg tablet)","NVP (Nevirapine 200 mg tablet)","Triomune baby (d4T/3TC/NVP 6/30/50mg tablet)","TDF/3TC (Tenofavir and Lamivudine 300/300mg tablet","Cotrimoxazole (480mg tablet)","Cotrimoxazole (960mg)","d4T/3TC (Stavudine Lamivudine 30/150 tablet)","TDF/3TC/EFV (300/300/600mg tablet)","AZT/3TC/NVP (300/150/200mg tablet)","d4T/3TC/NVP (30/150/200mg tablet)")                                                                                                                                                  

arv_prescription_observations = prescription_encounter_observations %>% filter(name %in% list_of_arv_drugs) %>% group_by(name,start_date,unique_patient_id) %>% slice(1)

number_of_arv_prescription_observations = arv_prescription_observations %>% filter(!is.na(quantity) ) %>% nrow()

#Drugs dispensed should be between 30 to 180 in quantity (15 days or 1 month to 3 months) to allow for examination. Will flag the dispensation beyond these quantities as not plausible
arv_prescription_observations$quantity = as.numeric(arv_prescription_observations$quantity)
arv_prescription_observations$plausible_observations = ifelse(arv_prescription_observations$quantity >=30 |arv_prescription_observations$quantity <=180, "Plausible","Not plausible")






number_of_all_plausible_prescriptions = arv_prescription_observations %>% filter(plausible_observations == "Plausible") %>% nrow()


all_prescription_plausibility_proportion = number_of_all_plausible_prescriptions / number_of_arv_prescription_observations  *100


#Plausible Adherence
#
all_health_facility_adherence$adherence_in_percentage = as.numeric(all_health_facility_adherence$adherence_in_percentage)


all_health_facility_adherence$plausible_adherence = ifelse(all_health_facility_adherence$adherence_in_percentage >= 95 & all_health_facility_adherence$adherence_in_percentage <= 105, "Plausible","Not plausible")

all_patients_with_plausible_adherence = all_health_facility_adherence %>% filter(start_date_new >= "2017-01-01") %>%  filter(plausible_adherence == "Plausible") 

number_of_all_patients_with_plausible_adherence = all_patients_with_plausible_adherence %>% nrow()

number_of_all_patients_with_adherence_observations = all_health_facility_adherence %>% filter(start_date_new >= "2017-01-01") %>% nrow()
  
proportion_all_plausible_adherence = number_of_all_patients_with_plausible_adherence / number_of_all_patients_with_adherence_observations * 100

#Plausible Viral load
#identify patients with more than two viral load
#Several categories. Select patients whose have a viral load start date is less than 6 months or more than a year after their ART start date. Check when Viral load measurement started as possible earliest date to avoid very long periods.
#

# viral_load_data_table_qech$patient_ART_start_date = as.Date(viral_load_data_table_qech$patient_ART_start_date, "%Y-%m-%d")
# viral_load_data_table_qech$patient_visit_date = as.Date(viral_load_data_table_qech$patient_visit_date, "%Y-%m-%d %T")

all_health_facility_vl$ART_start_date  = as.Date(all_health_facility_vl$ART_start_date, "%Y-%m-%d")
all_health_facility_vl$patient_visit_date  = as.Date(all_health_facility_vl$patient_visit_date, "%Y-%m-%d %T")

all_health_facility_vl$time_months = interval(
  all_health_facility_vl$ART_start_date,
  all_health_facility_vl$patient_visit_date
) %/% months(1)


all_months_until_first_vl = all_health_facility_vl %>% group_by(patient_id, ART_start_date) %>% slice(1)
all_months_until_first_vl$plausible = ifelse((all_months_until_first_vl$time_months >= 6 & all_months_until_first_vl$time_months <= 12), "Plausible","Not Plausible")


all_patients_with_plausible_vl_timeframe = all_months_until_first_vl %>%  filter(time_months == "Plausible") %>% nrow()

#  #check for patients with two or more viral load results on the same day that are different and flag these as "Not Plausible"
#

all_health_facility_vl = mutate(all_health_facility_vl, vrl_day_plausible =
                                    "Not Plausible")

#check if the same patient has more than 1 viral load on the same day but different values
#
plausible_viral_loads_day_results = function(viral_load_table){
output = character (nrow(viral_load_table))
viral_load_patient_ids = character (nrow(viral_load_table))
viral_load_dates = character (nrow(viral_load_table))
viral_load_patient_ids = viral_load_table$unique_patient_id
viral_load_dates = viral_load_table$patient_visit_date
viral_load_results = character(nrow(viral_load_table))
viral_load_results = viral_load_table$patient_VL_results

#registerDoParallel(cores=2)

for (i in 1:(nrow(viral_load_table) - 1)) 
{
  for (j in (2):(nrow(viral_load_table))) 
  {
    if ((viral_load_patient_ids[i] == viral_load_patient_ids[j]) & (viral_load_dates[i] == viral_load_dates[j]))
    {
      if(viral_load_results[i]==viral_load_results[j]){
        output[i] = "Plausible"
        output[j] = "Plausible"
      }else{
        output[i] = "Not plausible"
        output[j] = "Not plausible"
      }
      #viral_load_table$vrl_day_plausible[j] = "Plausible"
      # viral_load_table$vrl_day_plausible[i] = "Plausible"
      # viral_load_table$vrl_day_plausible[j] = "Plausible"
    }
  }
  print(i)
}
viral_load_table$vrl_day_plausible = output
write.csv(viral_load_table, file = "viral_load_table.csv")
return(viral_load_table) 
}

#count number of records that do not have a viral load test date as not complete.
#count records with test dates earlier than 2014-01-01 as not accurate. Avoid double counting.

#registerDoParallel(cores=4)

# if(find.file("viral_load_table.csv") =="viral_load_table.csv"){
#   viral_load_table = fread("viral_load_table.csv")
# }else{
# all_health_facility_vl = plausible_viral_loads_day_results(all_health_facility_vl)  
# }

vl_earlier_than_censor_date = all_health_facility_vl

vl_earlier_than_censor_date$plausible_firstdate =  ifelse(all_health_facility_vl$patient_visit_date <= "2014-01-01","Not plausible","Plausible")


# all_number_of_plausible_viral_loads_day_results = all_health_facility_vl %>% filter(plausible_viral_load == "Plausible") %>% nrow()
number_of_plausible_vl_earliest = vl_earlier_than_censor_date %>% filter(plausible_firstdate == "Plausible") %>% nrow()


number_of_all_plausible_viral_loads =  all_patients_with_plausible_vl_timeframe + number_of_plausible_vl_earliest


proportion_of_all_plausible_vl = number_of_all_plausible_viral_loads / nrow(all_health_facility_vl) * 100

#Build plausibility table to be used to display plausible results out of the complete results


#
variable_names_plausibility = c("Current Patient Physical Address","Patient Mobile Phone Number","Weights of Patient","Heights of Patient","Prescription Made","Drug Adherence","HIV Viral Load")

numerators_all_plausibility = c(number_of_all_plausible_addresses,
                                number_of_all_plausible_phone_numbers,
                                number_of_plausible_weight_observations,
                                number_of_all_plausible_height_observations,
                                number_of_all_plausible_prescriptions,
                                number_of_all_patients_with_plausible_adherence,
                                number_of_all_plausible_viral_loads)
 
denominators_all_plausibility = c(number_of_all_complete_addresses,number_of_all_complete_phone_numbers,all_number_of_complete_weight_observations,all_number_height_encounters_observations,number_of_arv_prescription_observations,number_of_all_patient_adherence_visits,number_of_all_complete_viral_loads)

proportions_all_plausibility = c(proportion_of_all_plausible_addresses,proportion_of_all_plausible_numbers,proportion_all_plausible_weights,proportion_all_plausible_heights,all_prescription_plausibility_proportion,proportion_all_plausible_adherence,proportion_of_all_plausible_vl)
 

all_plausibility_table = data.frame(variable_names_plausibility,numerators_all_plausibility,denominators_all_plausibility,proportions_all_plausibility, stringsAsFactors = FALSE)

all_plausibility_table$numerators_all_plausibility = as.numeric(all_plausibility_table$numerators_all_plausibility)
all_plausibility_table$denominators_all_plausibility = as.numeric(all_plausibility_table$denominators_all_plausibility)
all_plausibility_table$proportions_all_plausibility = as.numeric(all_plausibility_table$proportions_all_plausibility)

#means and standard deviations for normal distribution plot

fwgtmean <- mean(na.omit(study_period_vitals$weight_new))
fwgtsd   <- sd(na.omit(study_period_vitals$weight_new))
fhgtmean <- mean(na.omit(study_period_vitals$height_new))
fhgtsd   <- sd(na.omit(study_period_vitals$height_new))

  
```

### Results

*Completeness Tables

*Graph checking the completeness of address components. A complete address should have all components. 

*Plausibility Tables


```{r display_results}

kable(all_study_patients_characteristics, caption = "Table 1: Gender and Age by Health Facility Types of All Study Records", col.names = NA)

kable(study_patients_at_health_centers, caption = "Table 1: Gender and Age by Health Facility Names of All Study Records at Health Centers", col.names = NA)

kable(study_patients_at_district_hospitals, caption = "Table 1: Gender and Age by Health Facility Names of All Study Records at District Hospitals", col.names = NA)

kable(study_patients_at_tertiary, caption = "Table 1: Gender and Age by Health Facility Names of All Study Records at Tertiary Hospitals", col.names = NA)



#kable(all_healthfacility_completeness_table, caption = "Completeness of Documented Patient Records at Selected ART Clinics",col.names = c("Variable Name","Numerator Count","Denominator Count","Completeness Proportion"), digits = 2)
 
kable(number_of_patient_visits_per_health_facility, caption = "Number of patient visits by health facility name and health facility type")


kable(all_encounters_completeness_table, caption = "Completeness of Patient Visits Based on 90-90-90 Encounters at Selected Health Facilities",col.names = c("Indicator Name","Numerator Count","Denominator Count","Proportion of Encounters"), digits = 2)


ggplot(cd) + geom_bar(mapping = aes(x = address_section, fill = address_value), position = "dodge") + labs(title = "Completeness of Patient Address Components Documentation", x = "Patient Address Section", y = "Count of Documented Status", colour = "Documentation Status")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank(),panel.background = element_blank(), legend.title = element_blank()) + facet_grid(.~health_facility_type)



kable(all_plausibility_table, caption = "Plausibility of Complete Patient Record Variables at Selected ART Clinics in Malawi", digits = 2)


ggplot(arv_prescription_observations, aes(health_facility_name.x,quantity)) + geom_boxplot() + labs(title = "Average quantity of drugs dispensed at ART clinics", x = "Health Facility Name", y = "Quantity of Drugs Dispensed")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank(),panel.background = element_blank(), legend.title = element_blank())

# Distribution of weight observations. We expect the observations to be normally distributed across the clinics.


ggplot(study_period_vitals, aes(height_new)) + geom_histogram(aes(y = ..density..)) + stat_function(fun = dnorm, args = c(mean = fhgtmean, sd = fhgtsd), col = "blue", size = 1) + labs(title = "Distribution of Height Values at Selected ART Clinics", x = "Height observations", y = "Density of documented height observations")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank(),panel.background = element_blank(), legend.title = element_blank()) 

# Distribution of weight observations. We expect the observations to be normally distributed across the clinics.

ggplot(study_period_vitals, aes(weight_new)) + geom_histogram(aes(y = ..density..)) + stat_function(fun = dnorm, args = c(mean = fwgtmean, sd = fwgtsd), col = "blue", size = 1) + labs(title = "Distribution of Weight Values at Selected ART Clinics", x = "Weight observations", y = "Density of documented weight observations")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank(),panel.background = element_blank(), legend.title = element_blank())


```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.









