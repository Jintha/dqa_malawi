---
title: "data_quality_assessment_malawi"
author: "ojgadabu"
date: "2/5/2019"
output:
  pdf_document: default
  html_document: default
---

```{r global_options, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 8,
                      warning = FALSE, message = FALSE)
library(biotools)
library(psych)
library(QuantPsyc)
library(pastecs)
library(corrgram)
library(gplots)
library(cluster)
library(tidyverse)
library(pwr)
library(xtable)
library(stargazer)
library(knitr)
library(sjPlot)
library(plyr)
library(sjmisc)
library(Hmisc)
library(MBESS)
library(apaTables)
library(rockchalk)
library(gmodels)
library(car)
```
## Starting data quality assessment using the kahn framework with the data quality attributes of:

Completeness: Presence of data for an observation regardless of the structure or value of the data. For VL could be -100 or 700 or 200,000.
Conformance: Adherence of data to a predefined format or structure of the data. This could be domain of values, for example, VL not having a value of -20 which would be outside the domain of defined values.
Plausibility: This is the believability or truthfulness of observed data values, for example a patient with two viral load observations of 5000 and 700 within a space of a month. 



```{r echo=FALSE}
# read in a dataset with all its tables: 
# test code
 
 setwd("~/Dropbox/dissertation_data_analysis/")

 id_data_table           = read.csv("QECH_tables/qech_query_1.csv", stringsAsFactors = FALSE)
 drugs_data_table      = read.csv("QECH_tables/qech_query_2.csv", stringsAsFactors = FALSE)
 bmi_data_table = read.csv("QECH_tables/qech_query_3.csv", stringsAsFactors = FALSE)
 viral_load_data_table   = read.csv("QECH_tables/qech_query_4.csv", stringsAsFactors = FALSE)

 cd = gather(id_data_table,"address_section","address_value",2:4) 
 
# cd$address_value = ifelse(cd$address_value == "Other"), "Other", cd$address_value))

 cd$address_value = ifelse((cd$address_value == "Other"), "Documented Other",cd$address_value)
 cd$address_value = ifelse((cd$address_value == "NULL"), "Not documented",cd$address_value)
 cd$address_value = ifelse((cd$address_value != "Documented Other" &  cd$address_value != "Not documented" ), "Address Unit Documented", cd$address_value) 
 
 cd$address_section = as.factor(cd$address_section)
 cd$address_value = as.factor(cd$address_value)
 
 #Analyze the addresses as the field used for following up patients. Check the total number of patients that have been registered at each facility. Modification is that patient identifier no longer checked because HIV Testing Services (HTS) is not part of the available EMRs. Therefore check for total number of patients per site, then assess completeness of physical address as a set of "TA, district and village (current place of residence)"
#Patients with complete physical addresses. We define complete village as all addresses that have got the smallest unit of address which represents the current place of residence. Residents without current place of residence cannot be followed up if they miss an appointment. This is a threat to the second 90 of patient retention. 

 
ggplot(cd) + geom_bar(mapping = aes(x = address_section, fill = address_value), position = "dodge") + labs(title = "Completeness of Patient Address Components Documentation", x = "Patient Address Section", y = "Count of Documented Status", colour = "Documentation Status")  + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank(),panel.background = element_blank(), legend.title = element_blank())

# count encounter dates and number of patient observed weight values for each date.

  bmi_data_table = mutate(bmi_data_table, new_encounter_date  =  as.Date(bmi_data_table$encounter_datetime, "%Y-%m-%d %T"))

  bmi_data_table$height = as.integer(bmi_data_table$height)
  bmi_data_table$weight = as.integer(bmi_data_table$weight)
  bmi_data_table$patient_id = as.integer(bmi_data_table$patient_id)
# Total number of patient encounter dates.
# Total number of weight observations
  
  number_of_weights_documented = bmi_data_table %>% filter(weight > 0) %>% nrow(.)
  number_of_heights_documented = bmi_data_table %>% filter(height > 0) %>% nrow(.)
  number_of_encounter_dates = bmi_data_table %>% filter(!is.na(new_encounter_date)) %>% nrow(.)
  
#plot number of encounters per day for each patient
#create a dataframe that has month name and number of encounters in that month
#then add to that dataframe number of weight and height observations per month
#After that then plot the graphs on one layer with different types of observations
#Should result in 3 line geoms. Expectation is that weight should be at each visit.

  ggplot(bmi_data_table, aes(x = new_encounter_date, y = weight)) + geom_line()

  
  
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.








